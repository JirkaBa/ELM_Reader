<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ELM Reader</title>
  <meta name="description" content="Webová aplikace pro čtení dat z OBD-II ELM327 přes Bluetooth.">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="stylesheet" href="styles.css">
  <script defer src="app.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="branding">
      <span class="dot"></span>
      <div>
        <h1>ELM Reader</h1>
        <p class="subtitle">Aktuální a průměrná spotřeba pro VW Transporter T5 (2008)</p>
      </div>
    </div>
    <button id="installPrompt" class="ghost-button" hidden>Instalovat jako aplikaci</button>
  </header>

  <main>
    <section class="card hero">
      <div class="hero-controls">
        <button id="connectBtn" class="primary-button">Připojit OBD-II</button>
        <button id="disconnectBtn" class="secondary-button" disabled>Odpojit</button>
        <button id="simulateBtn" class="ghost-button">Vyzkoušet simulaci</button>
      </div>
      <div class="status">
        <p><strong>Stav:</strong> <span id="connectionState">Nepřipojeno</span></p>
        <p><strong>Zařízení:</strong> <span id="deviceName">—</span></p>
        <p><strong>Běh smyčky:</strong> <span id="pollingState">neaktivní</span></p>
      </div>
    </section>

    <section class="card data-card">
      <h2>Spotřeba</h2>
      <div class="data-grid">
        <div class="data-point prominent">
          <h3>Aktuální</h3>
          <p id="instantConsumption" class="value">—</p>
          <span class="unit">l / 100 km</span>
        </div>
        <div class="data-point">
          <h3>Průměrná</h3>
          <p id="averageConsumption" class="value">—</p>
          <span class="unit">l / 100 km</span>
        </div>
        <div class="data-point">
          <h3>Okamžitý průtok</h3>
          <p id="fuelFlow" class="value">—</p>
          <span class="unit">l / h</span>
        </div>
        <div class="data-point">
          <h3>Rychlost</h3>
          <p id="vehicleSpeed" class="value">—</p>
          <span class="unit">km / h</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Průběh jízdy</h2>
      <div class="trip-stats">
        <div>
          <span class="label">Ujetá vzdálenost</span>
          <strong id="tripDistance">0.00 km</strong>
        </div>
        <div>
          <span class="label">Spotřebované palivo</span>
          <strong id="tripFuel">0.00 l</strong>
        </div>
        <div>
          <span class="label">Doba připojení</span>
          <strong id="sessionDuration">0:00</strong>
        </div>
      </div>
      <button id="resetTripBtn" class="ghost-button">Vynulovat statistiky</button>
    </section>

    <section class="card instructions">
      <h2>Jak na to</h2>
      <ol>
        <li>Nastartuj Transporter T5 (2008, 1.9 TDI) a zapoj adaptér ELM327 Bluetooth do zásuvky OBD-II.</li>
        <li>Na telefonu/tabletu otevři tuto stránku přes GitLab Pages v prohlížeči Chrome (Android) nebo Edge/Chrome (desktop).</li>
        <li>Klikni na „Připojit OBD-II“ a v dialogu vyber zařízení (často se jmenuje „OBDII“, „OBDII BLE“, „V-LINK“ atd.).</li>
        <li>Po úspěšném připojení aplikace automaticky inicializuje ELM327 a začne načítat PIDs 010D (rychlost) a 0110 (MAF).</li>
        <li>Když se nepodaří najít BLE servis, otevři „Pokročilá nastavení“, zkus přepnout profil na JDY nebo jiný a zopakuj připojení. Můžeš také snížit interval dotazování.</li>
        <li>Hodnota „Aktuální“ se počítá ze MAF: <code>flow = ((MAF / AFR) / hustota) * 3600</code> a následně <code>spotřeba = flow / rychlost * 100</code>. Pro diesel se používá AFR 14,5 a hustota 0,832 kg/l.</li>
      </ol>
      <p class="note">
        Pokud se nepodaří získat data z MAF (PID 0110), zkontroluj, zda má jednotka tento PID povolený. Některé jednotky mohou vyžadovat jiný profil BLE – v nastavení aplikace lze přepnout profil ručně.
      </p>
    </section>

    <section class="card telemetry">
      <h2>Telemetrie a log</h2>
      <div class="log-controls">
        <button id="clearLogBtn" class="ghost-button">Vyčistit log</button>
        <label class="toggle">
          <input type="checkbox" id="rawToggle" checked>
          <span>Zobrazovat surové odpovědi</span>
        </label>
      </div>
      <pre id="logWindow" class="log-window" aria-live="polite"></pre>
    </section>
  </main>

  <footer class="app-footer">
    <p>Vyvinuto pro Autocraft ELM327 &rsaquo; GitLab Pages ready.</p>
    <a href="#!" id="openSettings">Pokročilá nastavení</a>
  </footer>

  <dialog id="settingsDialog">
    <form method="dialog">
      <h2>Pokročilá nastavení</h2>
      <label for="profileSelect" class="block-label">Bluetooth profil</label>
      <select id="profileSelect">
        <option value="auto">Automaticky (doporučeno)</option>
        <option value="jdy">JDY / FFF0-FFF2</option>
        <option value="hm10">HM-10 / FFE0-FFE1 (většina BLE ELM)</option>
        <option value="nus">Nordic UART (6E40…)</option>
        <option value="sps">SPS (49535343…)</option>
      </select>

      <label for="pollingInterval" class="block-label">Interval dotazování (ms)</label>
      <input type="number" id="pollingInterval" min="200" step="100" value="1000">

      <label for="afrInput" class="block-label">AFR (poměr vzduch/palivo)</label>
      <input type="number" id="afrInput" min="10" max="20" step="0.1" value="14.5">

      <label for="densityInput" class="block-label">Hustota paliva (kg/l)</label>
      <input type="number" id="densityInput" min="0.6" max="1.0" step="0.001" value="0.832">

      <div class="dialog-actions">
        <button value="cancel" class="ghost-button">Zavřít</button>
        <button id="saveSettingsBtn" value="default" class="primary-button">Uložit</button>
      </div>
    </form>
  </dialog>
</body>
</html>
